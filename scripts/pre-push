#!/bin/bash
# Pre-push hook to ensure CI checks will pass
# Install with: make install-hooks

set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# Git runs hooks with GIT_* vars set; they break nested git usage in tests.
unset GIT_DIR GIT_WORK_TREE GIT_INDEX_FILE GIT_COMMON_DIR GIT_PREFIX
unset GIT_OBJECT_DIRECTORY GIT_ALTERNATE_OBJECT_DIRECTORIES GIT_CEILING_DIRECTORIES

echo "Running pre-push checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

check_failed() {
    echo -e "${RED}Pre-push check failed: $1${NC}"
    echo "Fix the issues above before pushing."
    exit 1
}

check_passed() {
    echo -e "${GREEN}âœ“ $1${NC}"
}

run_check() {
    local label="$1"
    shift

    echo "Running ${label}..."
    if ! "$@" 2>&1; then
        check_failed "${label}"
    fi
    check_passed "${label}"
}

run_check "Build" make build
run_check "Vet" make vet
run_check "Lint" make lint
run_check "Tests" make test

echo -e "${GREEN}All pre-push checks passed!${NC}"
